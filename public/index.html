
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard IoT Energia</title>
<style>
  body { background:#0f0000; color:white; font-family:Arial; margin:0; }
  header { background:#330000; padding:20px; text-align:center; font-size:28px; color:#ff4d4d; }
  .container { padding:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .card { background:#260000; padding:20px; border-radius:10px; box-shadow:0 0 10px #550000; }
  h2 { color:#ff3333; margin-top:0; }
  #historicoTable { width:100%; border-collapse:collapse; }
  td, th { border:1px solid #550000; padding:6px; }
  canvas { background:#1a0000; border-radius:10px; }
  @media (max-width:900px) {
    .container { grid-template-columns:1fr; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>Painel de Energia IoT — ESP32</header>

<div class="container">

  <div class="card">
    <h2>Leitura Atual</h2>
    <p id="leituraAtual">Carregando...</p>
  </div>

  <div class="card">
    <h2>Gráfico: Energia (Wh)</h2>
    <canvas id="graficoEnergia"></canvas>
  </div>

  <div class="card">
    <h2>Gráfico: Potência (W)</h2>
    <canvas id="graficoPotencia"></canvas>
  </div>

  <div class="card" style="grid-column:1 / 3;">
    <h2>Histórico Completo</h2>
    <table id="historicoTable">
      <thead><tr><th>V</th><th>I</th><th>P</th><th>E</th><th>Hora</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<script>
let chartE = null;
let chartP = null;

async function carregar() {
  const res = await fetch('/historico');
  const dados = await res.json();
  if (dados.length === 0) return;

  const ultimo = dados[dados.length - 1];

  document.getElementById('leituraAtual').innerHTML =
    "<b>Tensão:</b> " + ultimo.voltage + " V<br>" +
    "<b>Corrente:</b> " + ultimo.current + " A<br>" +
    "<b>Potência:</b> " + ultimo.power + " W<br>" +
    "<b>Energia:</b> " + ultimo.energy + " Wh";

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = dados.map(d => `
    <tr>
      <td>${d.voltage}</td>
      <td>${d.current}</td>
      <td>${d.power}</td>
      <td>${d.energy}</td>
      <td>${new Date(d.timestamp).toLocaleString()}</td>
    </tr>
  `).join('');

  const labels = dados.map(d => new Date(d.timestamp).toLocaleTimeString());
  const energia = dados.map(d => d.energy);
  const potencia = dados.map(d => d.power);

  if (!chartE) {
    chartE = new Chart(document.getElementById('graficoEnergia'), {
      type:"line",
      data:{ labels, datasets:[{ label:"Energia (Wh)", data:energia, borderWidth:2 }] }
    });
  } else {
    chartE.data.labels = labels;
    chartE.data.datasets[0].data = energia;
    chartE.update();
  }

  if (!chartP) {
    chartP = new Chart(document.getElementById('graficoPotencia'), {
      type:"line",
      data:{ labels, datasets:[{ label:"Potência (W)", data:potencia, borderWidth:2 }] }
    });
  } else {
    chartP.data.labels = labels;
    chartP.data.datasets[0].data = potencia;
    chartP.update();
  }
}

carregar();
setInterval(carregar, 4000);
</script>

</body>
</html>
